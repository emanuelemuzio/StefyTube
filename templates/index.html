<!DOCTYPE html>
<html>
{% import 'macros.html' as macros %}
<head>
  <meta charset="UTF-8">
  <title>StefyTube</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='icon.ico') }}">
</head>

<body>
  {{ macros.navbar() }}

  <div class="container-lg mt-5">
    {{ macros.logo() }}
    {{ macros.downloadForm() }}
    {{ macros.downloadStatus() }}
    <div class="mt-3" id="statusMessage"></div>
  </div>

  <script>
    let lastStartedDownload = null;

    $('#downloadForm').on('submit', function (e) {
      e.preventDefault();

      const formatSelected = $('#formatSelect').val();
      const url = $('input[name="url"]').val();

      $('#statusMessage').text('');

      fetch('/download', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: new URLSearchParams({
          url: url,
          format: formatSelected
        })
      })
      .then(() => {
        lastStartedDownload = { format: formatSelected };  // usa per filtrare i progressi
        checkProgress();
      });
    });

    function checkProgress() {
      const interval = setInterval(() => {
        fetch('/progress')
          .then(res => res.json())
          .then(data => {
            if (!Array.isArray(data)) {
              clearInterval(interval);
              $('#statusMessage').html('<div class="alert alert-danger">Errore imprevisto nella progress</div>');
              return;
            }

            const current = data.find(d => d.format === lastStartedDownload.format);

            if (current) {

              if (current.status === 'finished') {
                clearInterval(interval);
                $('#statusMessage').html('<div class="alert alert-light">Download completato: ' + current.filename + '</div>');
              } else if (current.status === 'error') {
                clearInterval(interval);
                $('#statusMessage').html('<div class="alert alert-danger">Errore: ' + current.filename + '</div>');
              }
            } else {
              // Nessun download in corso trovato
              clearInterval(interval);
            }
          });
      }, 1000);
    }

    function openDownloads(e) {
      e.preventDefault();
      fetch('/open-downloads')
        .then(res => res.json())
        .then(data => {
          if (!data.success) alert("Errore: " + data.error);
        });
    }

    function updateDownloadStatus() {
      fetch('/progress')
        .then(res => res.json())
        .then(data => {
          const container = document.getElementById('downloadStatus');
          if (!data.length) {
            container.innerHTML = '';
            return;
          }

          container.innerHTML = '<h5 class="mb-2">⏳ Download in corso:</h5>' + data.map(d =>
            `<div class="mb-2 p-2 bg-dark text-light rounded">
              <strong>${d.filename || '(in preparazione...)'}</strong><br>
              Stato: ${d.status} – ${d.progress}%
              <div class="progress mt-1" style="height: 8px;">
                <div class="progress-bar" style="background-color: #d71612; width: ${d.progress}%"></div>
              </div>
            </div>`
          ).join('');
        });
    }

    setInterval(updateDownloadStatus, 3000);
    updateDownloadStatus();
  </script>
</body>
</html>
