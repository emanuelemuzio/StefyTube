<!DOCTYPE html>
<html>

{% import 'macros.html' as macros %}

<head>
  <title>StefyTube</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>
  {{ macros.navbar() }}

  <div class="container-lg mt-5">
    {{ macros.logo() }}

    {{ macros.downloadForm() }}

    <!-- <div class="progress" style="height: 25px; display: none;">
      <div class="progress-bar" role="progressbar" style="width: 0%;" id="progressBar">0%</div>
    </div> -->

    {{ macros.downloadStatus() }}
    <!-- <div class="mt-3" id="statusMessage"></div> -->
    <script>
      let formatSelected = 'mp3';

      $('#downloadForm').submit(function (e) {
        e.preventDefault();
        const formatSelected = $('#formatSelect').val();
        const url = $('input[name="url"]').val();

        $('#statusMessage').text('');
        $('.progress').show();
        $('#progressBar').css('width', '0%').text('0%');

        $.post('/download', { url, format: formatSelected }, function (response) {
          checkProgress();
        });
      });

      function checkProgress() {
        const interval = setInterval(() => {
          $.get('/progress', function (data) {
            const progress = data.progress;
            $('#progressBar').css('width', progress + '%').text(progress + '%');

            if (data.status === 'finished') {
              clearInterval(interval);
              $('#statusMessage').html('<div class="alert alert-light">Download completato: ' + data.filename + '</div>');
            } else if (data.status === 'error') {
              clearInterval(interval);
              $('#statusMessage').html('<div class="alert alert-danger">Errore: ' + data.filename + '</div>');
            }
          });
        }, 1000);
      }

      function openDownloads(e) {
        e.preventDefault();
        fetch('/open-downloads')
          .then(res => res.json())
          .then(data => {
            if (!data.success) alert("Errore: " + data.error);
          });
      }

      function updateDownloadStatus() {
        fetch('/progress')
          .then(res => res.json())
          .then(data => {
            const container = document.getElementById('downloadStatus');
            if (!data.length) {
              container.innerHTML = '';
              return;
            }

            const relevant = data.filter(d => {
              {% if 'player' in request.path %}
              return d.format === 'mp3';
              {% elif 'video-player' in request.path %}
              return d.format === 'mp4';
              {% else %}
              return true;
              {% endif %}
            });

            if (!relevant.length) {
              container.innerHTML = '';
              return;
            }

            container.innerHTML = '<h5 class="mb-2">⏳ Download in corso:</h5>' + relevant.map(d =>
              `<div class="mb-2 p-2 bg-dark text-light rounded">
              <strong>${d.filename || '(in preparazione...)'}</strong><br>
              Stato: ${d.status} – ${d.progress}%
              <div class="progress mt-1" style="height: 8px;">
                <div class="progress-bar bg-info" style="width: ${d.progress}%"></div>
              </div>
            </div>`
            ).join('');
          });
      }

      setInterval(updateDownloadStatus, 3000);
      updateDownloadStatus();
    </script>
  </div>

</body>

</html>