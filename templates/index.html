<!DOCTYPE html>
<html>

<head>
  <title>StefyTube</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body {
      background-color: #100f12;
      color: #f1f1f1;
    }

    .form-control {
      background-color: #1e1e1e;
      color: #f1f1f1;
      border: 1px solid #444;
      box-shadow: none !important;
    }

    .form-control::placeholder {
      color: #999;
    }

    .form-control:focus {
      background-color: #1e1e1e;
      color: #f1f1f1;
      border: 1px solid #444;
      outline: none;
      box-shadow: none;
    }

    .progress {
      background-color: #333;
    }

    .progress-bar {
      background-color: #e50914;
    }

    .btn-primary {
      background-color: #e50914;
      border: none;
    }

    .btn-primary:hover {
      background-color: #c40812;
    }

    .btn-success {
      background-color: #3ddc84;
      border: none;
    }

    .btn-success:hover {
      background-color: #2cc570;
    }

    .btn-outline-dark {
      color: #f1f1f1;
      border-color: #f1f1f1;
    }

    .btn-outline-dark:hover {
      background-color: #f1f1f1;
      color: #121212;
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <div class="collapse navbar-collapse justify-content-end">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link{% if request.path == '/' %} active{% endif %}" href="/">Downloader</a>
          </li>
          <li class="nav-item">
            <a class="nav-link{% if request.path == '/player' %} active{% endif %}" href="/player">Player</a>
          </li>
          <li class="nav-item">
            <a class="nav-link{% if request.path.startswith('/playlist') %} active{% endif %}"
              href="/playlists">Playlist</a>
          </li>
          <li class="nav-item">
            <a class="nav-link{% if request.path == '/video-player' %} active{% endif %}" href="/video-player">Video</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>


  <div class="container-lg mt-5">
    <div class="text-center mb-4">
      <img src="/logo" alt="StefyTube Logo" style="max-height: 120px;">
    </div>

    <form id="downloadForm">
      <div class="mb-3">
        <input type="text" name="url" class="form-control" placeholder="Incolla il link di YouTube" required>
      </div>
      <div class="row justify-content-center mb-3">
        <div class="col-auto">
          <select id="formatSelect" class="form-select bg-dark text-white border-secondary">
            <option value="mp3">Scarica in MP3</option>
            <option value="mp4">Scarica in MP4</option>
          </select>
        </div>
        <div class="col-auto">
          <button type="submit" class="btn btn-primary">Scarica</button>
        </div>
        <div class="text-center mt-4">
          <button class="btn btn-secondary" onclick="openDownloads()">ðŸ“‚ Apri cartella Downloads</button>
        </div>
      </div>

    </form>

    <div class="progress" style="height: 25px; display: none;">
      <div class="progress-bar" role="progressbar" style="width: 0%;" id="progressBar">0%</div>
    </div>

    <div class="mt-3" id="statusMessage"></div>
  </div>

  <script>
    let formatSelected = 'mp3';

    $('#downloadForm').submit(function (e) {
      e.preventDefault();
      const formatSelected = $('#formatSelect').val();
      const url = $('input[name="url"]').val();

      $('#statusMessage').text('');
      $('.progress').show();
      $('#progressBar').css('width', '0%').text('0%');

      $.post('/download', { url, format: formatSelected }, function (response) {
        checkProgress();
      });
    });

    function checkProgress() {
      const interval = setInterval(() => {
        $.get('/progress', function (data) {
          const progress = data.progress;
          $('#progressBar').css('width', progress + '%').text(progress + '%');

          if (data.status === 'finished') {
            clearInterval(interval);
            $('#statusMessage').html('<div class="alert alert-light">Download completato: ' + data.filename + '</div>');
          } else if (data.status === 'error') {
            clearInterval(interval);
            $('#statusMessage').html('<div class="alert alert-danger">Errore: ' + data.filename + '</div>');
          }
        });
      }, 1000);
    }

    function openDownloads() {
      fetch('/open-downloads')
        .then(res => res.json())
        .then(data => {
          if (!data.success) alert("Errore: " + data.error);
        });
    }
  </script>
</body>

</html>