<!DOCTYPE html>
<html>

{% import 'macros.html' as macros %}

<head>
  <title>StefyTube</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>
    {{ macros.navbar() }} 

    <div class="container mt-4">
        <h3 class="mb-3">üéß Playlist: {{ playlist.name }}</h3>

        {% if playlist.tracks %}
        <ul class="list-group mb-4" id="trackList">
            {% for track in playlist.tracks %}
            <li style="color: white;" class="list-group-item d-flex justify-content-between align-items-center"
                id="track-{{ loop.index0 }}" data-filename="{{ track }}">
                {{ track }}
                <div class="d-flex align-items-center gap-2">
                    <audio controls style="min-width: 300px;">
                        <source src="/downloads/{{ track }}" type="audio/mpeg">
                    </audio>
                    <button class="btn btn-sm btn-danger"
                        onclick="removeTrack('{{ playlist.name }}', '{{ track }}', {{ loop.index0 }})">üóë</button>
                </div>
            </li>
            {% endfor %}
        </ul>


        <div class="text-center mb-3 d-flex justify-content-center gap-2">
            <button class="btn btn-shuffle" onclick="playInOrder()">‚ñ∂Ô∏è Riproduzione sequenziale</button>
            <button class="btn btn-secondary" onclick="prevTrack()">‚èÆÔ∏è</button>
            <button class="btn btn-secondary" onclick="nextTrack()">‚è≠Ô∏è</button>
        </div>

        <div class="text-center mt-3">
            <audio id="audioPlayer" controls hidden style="width: 90%; max-width: 600px;"></audio>
            <div id="nowPlaying" class="mt-2 fw-bold"></div>
        </div>
        {% else %}
        <div class="alert alert-info">Questa playlist √® vuota.</div>
        {% endif %}
    </div>

    <script>
        const playlist = {{ playlist.tracks| tojson }};
        let queue = [];
        let current = 0;
        const audio = document.getElementById('audioPlayer');
        const nowPlaying = document.getElementById('nowPlaying');
        const allAudios = Array.from(document.querySelectorAll('audio'));
        if (audio && !allAudios.includes(audio)) {
            allAudios.push(audio);
        }

        allAudios.forEach(audioEl => {
            audioEl.addEventListener('play', () => {
                allAudios.forEach(other => {
                    if (other !== audioEl) {
                        other.pause();
                        other.currentTime = 0;
                    }
                });
            });
        });

        function highlightActiveTrack(filename) {
            const items = document.querySelectorAll('#trackList li');
            items.forEach(item => {
                if (item.dataset.filename === filename) {
                    item.classList.add('active-track');
                } else {
                    item.classList.remove('active-track');
                }
            });
        }


        function playInOrder() {
            if (!playlist.length) return;
            queue = [...playlist];
            current = 0;
            audio.hidden = false;
            loadTrack(current);
        }

        function playRandom() {
            if (!playlist.length) return;
            queue = [...playlist];
            for (let i = queue.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [queue[i], queue[j]] = [queue[j], queue[i]];
            }
            current = 0;
            audio.hidden = false;
            loadTrack(current);
        }

        function loadTrack(index) {
            const file = queue[index];
            audio.src = `/downloads/${file}`;
            audio.load();
            audio.play();
            nowPlaying.textContent = `üéµ In riproduzione: ${file}`;
            highlightActiveTrack(file);
        }

        document.querySelectorAll('audio').forEach(audioEl => {
            audioEl.addEventListener('play', () => {
                document.querySelectorAll('audio').forEach(other => {
                    if (other !== audioEl) {
                        other.pause();
                        other.currentTime = 0;
                    }
                });
            });
        });


        function nextTrack() {
            if (current < queue.length - 1) {
                current++;
                loadTrack(current);
            } else {
                nowPlaying.textContent = '‚úÖ Playlist terminata.';
            }
        }

        function prevTrack() {
            if (current > 0) {
                current--;
                loadTrack(current);
            }
        }

        audio.onended = () => {
            nextTrack();
        };

        function removeTrack(playlist, track, index) {
            if (!confirm(`Vuoi rimuovere "${track}" da "${playlist}"?`)) return;

            fetch('/playlist/remove', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ playlist, track })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const row = document.getElementById(`track-${index}`);
                        if (row) row.remove();

                        // Rimuovilo dalla coda se √® in riproduzione
                        if (queue.length) {
                            queue = queue.filter(t => t !== track);
                            if (current >= queue.length) {
                                audio.pause();
                                nowPlaying.textContent = '‚úÖ Playlist aggiornata.';
                            }
                        }
                    } else {
                        alert('Errore: ' + data.error);
                    }
                });
        }

    </script>

</body>

</html>