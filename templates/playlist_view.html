<!DOCTYPE html>
<html>

{% import 'macros.html' as macros %}

<head>
    <title>StefyTube</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>
    {{ macros.navbar() }}

    <div class="container mt-4">
        {{ macros.logo() }}
        <h3 class="mb-3">ðŸŽ§ Playlist: {{ playlist.name }}</h3>

        {% if playlist.tracks %}
        <ul class="list-group mb-4" id="trackList">
            {% for track in playlist.tracks %}
            <li style="color: white;" class="list-group-item d-flex justify-content-between align-items-center"
                id="track-{{ loop.index0 }}" data-filename="{{ track }}">
                {{ track }}
                <div class="d-flex align-items-center gap-2">
                    <audio controls style="min-width: 300px;">
                        <source src="/downloads/{{ track }}" type="audio/mpeg">
                    </audio>
                    <button class="btn btn-sm btn-danger"
                        onclick="removeTrack('{{ playlist.name }}', '{{ track }}', {{ loop.index0 }})">ðŸ—‘</button>
                </div>
            </li>
            {% endfor %}
        </ul>


        <div class="text-center mb-3 d-flex justify-content-center gap-2">
            <button class="btn btn-secondary" onclick="prevTrack()">Precedente</button>

            <button id="shuffleToggle" class="btn" style="background-color: #d71612; color: white; border: none;"
                onclick="toggleShuffle()">
                Riproduzione casuale: OFF
            </button>

            <button class="btn btn-secondary" onclick="nextTrack()">Successivo</button>
        </div>


        <div class="text-center mt-3">
            <audio id="audioPlayer" controls style="width: 90%; max-width: 600px;" class="d-block mx-auto" hidden>
                <source id="audioSource" src="" type="audio/mpeg">
                Il tuo browser non supporta l'audio.
            </audio>
            <div id="nowPlaying" class="mt-2 fw-bold"></div>
        </div>
        {% else %}
        <div class="alert alert-info">Questa playlist Ã¨ vuota.</div>
        {% endif %}
    </div>

    <script>
        let shuffleEnabled = false;
        let originalPlaylist = {{ playlist.tracks | tojson | safe }};
        let playlist = [...originalPlaylist];
        let currentIndex = 0;


        const audio = document.getElementById('audioPlayer');
        const source = document.getElementById('audioSource');
        const nowPlaying = document.getElementById('nowPlaying');
        const trackList = document.getElementById('trackList');

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function highlightTrack(filename) {
            const items = document.querySelectorAll('#trackList li');
            items.forEach(item => {
              const isCurrent = item.dataset.filename === filename;
              item.classList.toggle('active', isCurrent);
            });
          }
          

        function playTrack(index) {
            const file = playlist[index];
            source.src = `/downloads/${file}`;
            audio.load();
            audio.play();
            nowPlaying.textContent = `ðŸŽµ In riproduzione: ${file}`;
            highlightTrack(index);
        }

        function nextTrack() {
            currentIndex = (currentIndex + 1) % playlist.length;
            playTrack(currentIndex);
        }

        function prevTrack() {
            currentIndex = (currentIndex - 1 + playlist.length) % playlist.length;
            playTrack(currentIndex);
        }

        function toggleShuffle() {
            shuffleEnabled = !shuffleEnabled;
            const btn = document.getElementById('shuffleToggle');
            btn.textContent = `ðŸŽ² Riproduzione casuale: ${shuffleEnabled ? 'ON' : 'OFF'}`;

            playlist = shuffleEnabled ? shuffle([...originalPlaylist]) : [...originalPlaylist];
            currentIndex = 0;
            playTrack(currentIndex);
        }


        // Interrompe tutti gli altri audio nella pagina
        const allAudios = Array.from(document.querySelectorAll('audio'));
        if (!allAudios.includes(audio)) {
            allAudios.push(audio);
        }

        allAudios.forEach(audioEl => {
            audioEl.addEventListener('play', () => {
                allAudios.forEach(other => {
                    if (other !== audioEl) {
                        other.pause();
                        other.currentTime = 0;
                    }
                });
            });
        });

        // Quando il brano finisce, passa al successivo
        audio.addEventListener('ended', nextTrack);

        // Autoplay iniziale
        window.onload = () => {
            audio.addEventListener('ended', nextTrack)
        };

        
    </script>



</body>

</html>