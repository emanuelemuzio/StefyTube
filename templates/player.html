<!DOCTYPE html>
<html>

<head>
  <title>StefyTube - Player</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #100f12;
      color: #f1f1f1;
    }

    .list-group-item {
      background-color: #1e1e1e;
      border: 1px solid #333;
      color: #f1f1f1;
    }

    .alert {
      background-color: #2c2c2c;
      border-color: #444;
      color: #ccc;
    }

    .btn-secondary {
      background-color: #444;
      border: none;
    }

    .btn-secondary:hover {
      background-color: #555;
    }

    audio {
      filter: brightness(0.9);
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <div class="collapse navbar-collapse justify-content-end">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link{% if request.path == '/' %} active{% endif %}" href="/">Downloader</a>
          </li>
          <li class="nav-item">
            <a class="nav-link{% if request.path == '/player' %} active{% endif %}" href="/player">Player</a>
          </li>
          <li class="nav-item">
            <a class="nav-link{% if request.path.startswith('/playlist') %} active{% endif %}"
              href="/playlists">Playlist</a>
          </li>
          <li class="nav-item">
            <a class="nav-link{% if request.path == '/video-player' %} active{% endif %}" href="/video-player">Video</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>


  <div class="container-lg mt-5">
    <div class="text-center mb-4">
      <img src="/logo" alt="StefyTube Logo" style="max-height: 100px;">
    </div>

    <div class="text-center mb-4">
      <button class="btn mb-3" onclick="startShuffle()" style="background-color: #d71612; color: white; border: none;">
        Riproduzione casuale
      </button>

      <div class="d-flex justify-content-center align-items-center gap-2 mb-2" style="display: none;" id="controlsRow">
        <button class="btn btn-secondary" onclick="prevTrack()">Precedente</button>
        <button class="btn btn-secondary" onclick="nextTrack()">Successiva</button>
      </div>

      <audio id="audioPlayer" controls style="width: 90%; max-width: 600px;" class="d-block mx-auto" hidden>
        <source id="audioSource" src="" type="audio/mpeg">
        Il tuo browser non supporta l'audio.
      </audio>

      <div class="mt-2" id="nowPlaying" style="font-weight: bold;"></div>
    </div>

    {% if files %}
    <ul class="list-group mb-4">
      {% for file in files %}
      <li class="list-group-item d-flex justify-content-between align-items-center" id="item-{{ loop.index }}">
        <span>{{ file }}</span>
        <div class="d-flex align-items-center gap-2">
          <button class="btn btn-sm btn-danger" onclick="deleteFile('{{ file }}', {{ loop.index }})">ðŸ—‘</button>
          <audio controls style="min-width: 300px">
            <source src="{{ url_for('download_file', filename=file) }}" type="audio/mpeg">
          </audio>
          <select class="form-select form-select-sm bg-dark text-white"
            onchange="addToPlaylist('{{ file }}', this.value)">
            <option selected disabled>Aggiungi a...</option>
            {% for pl in playlists %}
            <option value="{{ pl }}">{{ pl }}</option>
            {% endfor %}
          </select>
        </div>
      </li>
      {% endfor %}
    </ul>
    {% else %}
    <div class="alert alert-info text-center">Nessun file MP3 disponibile nella cartella downloads.</div>
    {% endif %}
  </div>

  <script>
    const files = {{ files| tojson }};
    let queue = [];
    let current = 0;
    const audio = document.getElementById('audioPlayer');
    const source = document.getElementById('audioSource');
    const nowPlaying = document.getElementById('nowPlaying');
    const allAudios = Array.from(document.querySelectorAll('audio'));
    if (audio && !allAudios.includes(audio)) {
      allAudios.push(audio);
    }

    allAudios.forEach(audioEl => {
      audioEl.addEventListener('play', () => {
        allAudios.forEach(other => {
          if (other !== audioEl) {
            other.pause();
            other.currentTime = 0;
          }
        });
      });
    });

    function startShuffle() {
      queue = [...files];
      for (let i = queue.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [queue[i], queue[j]] = [queue[j], queue[i]];
      }

      current = 0;
      document.getElementById('controlsRow').style.display = 'flex';
      audio.hidden = false;
      loadTrack(current);
    }

    function loadTrack(index) {
      const file = queue[index];
      source.src = `/downloads/${file}`;
      audio.load();
      audio.play();
      nowPlaying.textContent = `In riproduzione: ${file}`;
    }

    function nextTrack() {
      if (current < queue.length - 1) {
        current++;
        loadTrack(current);
      } else {
        nowPlaying.textContent = 'Coda completata.';
      }
    }

    function prevTrack() {
      if (current > 0) {
        current--;
        loadTrack(current);
      }
    }

    audio.onended = () => {
      nextTrack();
    };

    function deleteFile(filename, index) {
      if (!confirm(`Sei sicuro di voler eliminare "${filename}"?`)) return;

      fetch('/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ filename })
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            document.getElementById(`item-${index}`).remove();
            nowPlaying.textContent = '';
            audio.pause();
          } else {
            alert('Errore durante l\'eliminazione: ' + data.error);
          }
        });
    }

    function addToPlaylist(filename, playlist) {
      fetch('/playlist/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playlist, track: filename })
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            alert(`Aggiunto a "${playlist}"`);
          } else {
            alert('Errore: ' + data.error);
          }
        });
    }

  </script>

</body>

</html>