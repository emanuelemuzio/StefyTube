<!DOCTYPE html>
<html>

{% import 'macros.html' as macros %}

<head>
  <title>StefyTube</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>

{{ macros.navbar() }}

  <div class="container-lg mt-5">
    {{ macros.logo() }}

    {% if progress.status != 'idle' and progress.status != 'finished' %}
    <div class="alert alert-info text-center">
      ‚è≥ Download in corso: <strong>{{ progress.filename }}</strong> ({{ progress.progress }}%)
    </div>
    {% endif %}

    {{ macros.playerShuffle() }}

    {% if files %}
    <ul class="list-group mb-4">
      {% for file in files %}
      <li class="list-group-item d-flex justify-content-between align-items-center" id="item-{{ loop.index }}">
        <span>{{ file }}</span>
        <div class="d-flex align-items-center gap-2">
          <button class="btn btn-sm" style="background-color: #d71612;" onclick="deleteFile('{{ file }}', {{ loop.index }})">üóë</button>
          <audio controls style="min-width: 300px">
            <source src="{{ url_for('download_file', filename=file) }}" type="audio/mpeg">
          </audio>
          <select class="form-select form-select-sm bg-dark text-white"
            onchange="addToPlaylist('{{ file }}', this.value)">
            <option selected disabled>Aggiungi a...</option>
            {% for pl in playlists %}
            <option value="{{ pl }}">{{ pl }}</option>
            {% endfor %}
          </select>
        </div>
      </li>
      {% endfor %}
    </ul>
    {% else %}
    <div class="alert alert-info text-center">Nessun file MP3 disponibile nella cartella downloads.</div>
    {% endif %}
  </div>

  <script>
    const files = {{ files| tojson }};
    let queue = [];
    let current = 0;
    const audio = document.getElementById('audioPlayer');
    const source = document.getElementById('audioSource');
    const nowPlaying = document.getElementById('nowPlaying');
    const allAudios = Array.from(document.querySelectorAll('audio'));
    if (audio && !allAudios.includes(audio)) {
      allAudios.push(audio);
    }

    allAudios.forEach(audioEl => {
      audioEl.addEventListener('play', () => {
        allAudios.forEach(other => {
          if (other !== audioEl) {
            other.pause();
            other.currentTime = 0;
          }
        });
      });
    });

    function startShuffle() {
      queue = [...files];
      for (let i = queue.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [queue[i], queue[j]] = [queue[j], queue[i]];
      }

      current = 0;
      document.getElementById('controlsRow').style.display = 'flex';
      audio.hidden = false;
      loadTrack(current);
    }

    function loadTrack(index) {
      const file = queue[index];
      source.src = `/downloads/${file}`;
      audio.load();
      audio.play();
      nowPlaying.textContent = `In riproduzione: ${file}`;
    }

    function nextTrack() {
      if (current < queue.length - 1) {
        current++;
        loadTrack(current);
      } else {
        nowPlaying.textContent = 'Coda completata.';
      }
    }

    function prevTrack() {
      if (current > 0) {
        current--;
        loadTrack(current);
      }
    }

    audio.onended = () => {
      nextTrack();
    };

    function deleteFile(filename, index) {
      if (!confirm(`Sei sicuro di voler eliminare "${filename}"?`)) return;

      fetch('/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ filename })
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            document.getElementById(`item-${index}`).remove();
            nowPlaying.textContent = '';
            audio.pause();
          } else {
            alert('Errore durante l\'eliminazione: ' + data.error);
          }
        });
    }

    function addToPlaylist(filename, playlist) {
      fetch('/playlist/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playlist, track: filename })
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            alert(`Aggiunto a "${playlist}"`);
          } else {
            alert('Errore: ' + data.error);
          }
        });
    }

  </script>

</body>

</html>